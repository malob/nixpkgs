# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build Commands

```bash
# Build and switch to the macOS nix-darwin configuration
nh darwin switch

# Build without switching (for testing)
nh darwin build

# Update all flake inputs
nix flake update

# Update a specific input
nix flake update nixpkgs-unstable

# Enter development shell with nixd and nixfmt
nix develop
```

## Architecture

This is a Nix flake that manages system configuration for macOS (via nix-darwin) and Linux (via home-manager).

### Key Structure

- **`flake.nix`** - Main entry point defining inputs, outputs, overlays, and system configurations
- **`darwin/`** - nix-darwin modules for macOS system-level configuration
- **`home/`** - home-manager modules for user-level configuration
- **`modules/`** - Reusable modules (both darwin and home-manager)
- **`lib/`** - Helper functions including `mkDarwinSystem`
- **`configs/`** - Application configs (Neovim, Claude Code) symlinked for live editing
- **`overlays/`** - Nixpkgs overlays

### System Configurations

- **`darwinConfigurations.MaloBookPro`** - Primary macOS config, built with `lib.mkDarwinSystem`
- **`darwinConfigurations.githubCI`** - CI variant with homebrew disabled
- **`homeConfigurations.malo`** - Standalone home-manager config for Linux

### User Info Pattern

User info is defined once and referenced throughout:

1. Passed to `lib.mkDarwinSystem` as `username`, `fullName`, `email`, `nixConfigDirectory`
2. Set on `users.primaryUser` in darwin config
3. Available as `config.home.user-info` in all home-manager modules

Example usage in a home module:
```nix
{ config, ... }:
let
  inherit (config.home.user-info) email nixConfigDirectory;
in { ... }
```

### Live-Editable Configs

Files in `configs/` are symlinked via `mkOutOfStoreSymlink`, allowing edits without rebuild:
- `configs/claude/` → `~/.claude/` (CLAUDE.md, mcp.json, commands, plugins, etc.)
- `configs/nvim/` → Neovim Lua config

**Exception:** `~/.claude/settings.json` is generated by Nix (in `home/claude.nix`) to interpolate machine-specific paths for portability.

### Package Version Overlays

Access packages from different nixpkgs channels via overlays:
```nix
pkgs.pkgs-master.some-package    # bleeding edge
pkgs.pkgs-unstable.some-package  # nixpkgs-unstable
pkgs.pkgs-stable.some-package    # stable release
pkgs.pkgs-x86.some-package       # x86 version (Apple Silicon only)
```

## Common Tasks

**Add a package:** Edit `home/packages.nix`, add to the appropriate category's `inherit` block.

**Add a new home-manager module:**
1. Create `home/tool.nix` with the module configuration
2. Add `malo-tool = import ./home/tool.nix;` to `homeManagerModules` in `flake.nix`
3. The module is automatically included via `attrValues self.homeManagerModules`

**Add a darwin module:** Same pattern in `darwin/` directory and `darwinModules` in flake.nix.

## Conventions

- Follow nixpkgs code style
- Module files named for their purpose (e.g., `git.nix`, `fish.nix`)
- Home-manager modules prefixed with `malo-` in flake outputs
- Use `inherit` for clarity when pulling from attribute sets
